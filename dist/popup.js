(()=>{async function t(){try{const t=await chrome.runtime.sendMessage({action:"getStats"});if(t.success){const e=t.data;document.getElementById("links-scanned").textContent=e.linksScanned||0,document.getElementById("threats-blocked").textContent=e.threatsBlocked||0;const n=e.linksScanned>0?(e.threatsBlocked/e.linksScanned*100).toFixed(1):0;document.getElementById("protection-rate").textContent=`${n}%`}await e()}catch(t){console.error("Error loading dashboard:",t),i("Failed to load dashboard","error")}}async function e(){try{const t=await chrome.storage.local.get("phishTankDB");if(t.phishTankDB){const{count:e,lastUpdated:n}=t.phishTankDB,a=Date.now()-n,o=Math.floor(a/36e5);document.getElementById("db-count").textContent=e.toLocaleString(),document.getElementById("db-updated").textContent=`${o}h ago`;const c=document.querySelector(".status-dot"),s=document.getElementById("db-status-text");a<864e5?(c.style.backgroundColor="#28a745",s.textContent="Up to date"):(c.style.backgroundColor="#ffc107",s.textContent="Update available")}else document.getElementById("db-count").textContent="0",document.getElementById("db-updated").textContent="Never",document.querySelector(".status-dot").style.backgroundColor="#dc3545",document.getElementById("db-status-text").textContent="Not downloaded"}catch(t){console.error("Error checking database status:",t)}}async function n(){try{const t=await chrome.storage.local.get("whitelist"),e=document.getElementById("whitelist-container");a(t.whitelist||[],e,"whitelist");const n=await chrome.storage.local.get("blacklist"),o=document.getElementById("blacklist-container");a(n.blacklist||[],o,"blacklist")}catch(t){console.error("Error loading lists:",t),i("Failed to load lists","error")}}function a(t,e,a){0!==t.length?(e.innerHTML=t.map(t=>`\n    <div class="list-item">\n      <span class="domain">${t}</span>\n      <button class="remove-btn" data-domain="${t}" data-type="${a}">×</button>\n    </div>\n  `).join(""),e.querySelectorAll(".remove-btn").forEach(t=>{t.addEventListener("click",()=>async function(t,e){try{const a=e,o=((await chrome.storage.local.get(a))[a]||[]).filter(e=>e!==t);await chrome.storage.local.set({[a]:o}),await chrome.runtime.sendMessage({action:"clearCache"}),i(`Removed ${t} from ${e}`,"success"),await n()}catch(t){console.error(`Error removing domain from ${e}:`,t),i("Failed to remove domain","error")}}(t.dataset.domain,t.dataset.type))})):e.innerHTML='<div class="empty-state">No domains added</div>'}async function o(t,e){try{if(!t||""===t.trim())return void i("Please enter a domain","error");if(t=t.trim().toLowerCase(),!/^[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,}$/.test(t))return void i("Invalid domain format","error");const a="whitelist"===e?"addToWhitelist":"addToBlacklist",o=await chrome.runtime.sendMessage({action:a,domain:t});o.success?(i(`Added ${t} to ${e}`,"success"),await n(),document.getElementById(`${e}-input`).value=""):i(`Failed to add domain: ${o.error}`,"error")}catch(t){console.error(`Error adding domain to ${e}:`,t),i("An error occurred","error")}}async function c(){try{const t=await chrome.runtime.sendMessage({action:"getSettings"});if(t.success){const e=t.data;document.getElementById("notify-dangerous").checked=!1!==e.notifyDangerous,document.getElementById("notify-suspicious").checked=!0===e.notifySuspicious,document.getElementById("notify-updates").checked=!1!==e.notifyUpdates;const n=e.protectionLevel||"strict";document.querySelector(`input[name="protection"][value="${n}"]`).checked=!0}}catch(t){console.error("Error loading settings:",t)}}async function s(){try{const t={notifyDangerous:document.getElementById("notify-dangerous").checked,notifySuspicious:document.getElementById("notify-suspicious").checked,notifyUpdates:document.getElementById("notify-updates").checked,protectionLevel:document.querySelector('input[name="protection"]:checked').value};(await chrome.runtime.sendMessage({action:"updateSettings",settings:t})).success?i("Settings saved","success"):i("Failed to save settings","error")}catch(t){console.error("Error saving settings:",t),i("An error occurred","error")}}function i(t,e="info"){const n=document.createElement("div");n.className=`toast toast-${e}`,n.textContent=t,document.getElementById("toast-container").appendChild(n),setTimeout(()=>n.classList.add("show"),10),setTimeout(()=>{n.classList.remove("show"),setTimeout(()=>n.remove(),300)},3e3)}document.addEventListener("DOMContentLoaded",async()=>{!function(){const t=document.querySelectorAll(".tab-btn"),e=document.querySelectorAll(".tab-content");t.forEach(n=>{n.addEventListener("click",()=>{const a=n.dataset.tab;t.forEach(t=>t.classList.remove("active")),e.forEach(t=>t.classList.remove("active")),n.classList.add("active"),document.getElementById(`${a}-tab`).classList.add("active")})})}(),await t(),await n(),await c(),document.getElementById("update-db-btn").addEventListener("click",async()=>{try{i("Updating database...","info"),await e(),i("Database status refreshed","success")}catch(t){i("Failed to refresh database status","error")}}),document.getElementById("export-data-btn").addEventListener("click",async()=>{try{const t=document.createElement("a"),e=await chrome.storage.local.get(null),n=new Blob([JSON.stringify(e,null,2)],{type:"application/json"});t.href=URL.createObjectURL(n),t.download=`apg-export-${Date.now()}.json`,t.click(),i("Data exported","success")}catch(t){i("Export failed","error")}}),document.getElementById("clear-cache-btn").addEventListener("click",async()=>{if(confirm("Clear all cached threat analysis?"))try{await chrome.runtime.sendMessage({action:"clearCache"}),i("Cache cleared","success"),await t()}catch(t){i("Failed to clear cache","error")}}),document.getElementById("health-check-btn").addEventListener("click",async()=>{try{const t=await chrome.storage.local.get(["phishTankDB","whitelist","blacklist"]),e=!!t.phishTankDB,n=(t.whitelist||[]).length,a=(t.blacklist||[]).length;alert(`System Health Check:\n\n✓ Database: ${e?"OK":"Missing"}\n✓ Whitelist: ${n} domains\n✓ Blacklist: ${a} domains\n✓ Extension: Running`)}catch(t){i("Health check failed","error")}}),document.getElementById("add-whitelist-btn").addEventListener("click",()=>{o(document.getElementById("whitelist-input").value,"whitelist")}),document.getElementById("add-blacklist-btn").addEventListener("click",()=>{o(document.getElementById("blacklist-input").value,"blacklist")}),document.getElementById("whitelist-input").addEventListener("keypress",t=>{"Enter"===t.key&&o(t.target.value,"whitelist")}),document.getElementById("blacklist-input").addEventListener("keypress",t=>{"Enter"===t.key&&o(t.target.value,"blacklist")}),document.querySelectorAll("#settings-tab input").forEach(t=>{t.addEventListener("change",s)}),document.getElementById("export-settings-btn").addEventListener("click",async()=>{try{const t=await chrome.storage.local.get(["whitelist","blacklist","settings"]),e=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),n=document.createElement("a");n.href=URL.createObjectURL(e),n.download=`apg-settings-${Date.now()}.json`,n.click(),i("Settings exported","success")}catch(t){i("Export failed","error")}}),document.getElementById("import-settings-btn").addEventListener("click",()=>{document.getElementById("import-file-input").click()}),document.getElementById("import-file-input").addEventListener("change",async e=>{const a=e.target.files[0];if(a)try{const e=await a.text(),o=JSON.parse(e);await chrome.storage.local.set(o),i("Settings imported","success"),await t(),await n(),await c()}catch(t){i("Import failed","error")}}),document.getElementById("factory-reset-btn").addEventListener("click",async()=>{if(confirm("Factory reset will delete ALL data. Continue?")&&confirm("Are you absolutely sure? This cannot be undone!"))try{await chrome.storage.local.clear(),i("Extension reset to defaults","success"),setTimeout(()=>window.location.reload(),1e3)}catch(t){i("Reset failed","error")}})})})();