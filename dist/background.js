(()=>{"use strict";const e="safe",t="suspicious",s="dangerous",a="unknown",r="whitelist",i="blacklist",o="settings",n="threatCache",c="stats",l={enabled:!0,showWarnings:!0,blockDangerous:!1,checkOnHover:!0,cacheExpiry:36e5,sensitivityLevel:"medium"},h=["verify","account","suspended","confirm","update","validate","reactivate","locked","blocked","restricted","frozen","urgent","immediately","act now","limited time","expire","expires","deadline","final notice","last chance","hurry","act fast","password","security","alert","warning","unusual activity","suspicious","unauthorized","breach","compromised","hacked","winner","prize","reward","congratulations","won","lottery","million","inheritance","fund","transfer","claim","click here","click below","verify now","confirm now","update now","download","open attachment","see details","view message","refund","tax","irs","payment","invoice","overdue","debt","owed","billing","charge","transaction","purchase","free","guarantee","risk-free","no cost","100%","amazing offer","special promotion","exclusive","selected","qualified","login","sign in","credentials","username","ssn","social security","re-enter","provide","submit","fill out","customer service","support team","helpdesk","admin","administrator","official","authorized","representative"],u=["viagra","cialis","pharmacy","pills","medication","weight loss","work from home","make money","earn $","get paid","income opportunity","mlm","multi-level","investment opportunity","crypto gains","bitcoin","forex","trading bot","guaranteed profit","enlarge","enhancement","replica","luxury goods","nigerian prince","beneficiary","next of kin","offshore","unsubscribe","opt-out","remove me","mailing list"],d=[".tk",".ml",".ga",".cf",".gq",".xyz",".top",".club",".work",".click",".link",".bid",".country"],g=["google.com","gmail.com","outlook.com","microsoft.com","apple.com","amazon.com","paypal.com","facebook.com","twitter.com","linkedin.com","github.com","dropbox.com","bankofamerica.com","chase.com","wellsfargo.com","citibank.com","usbank.com","pnc.com","capitalone.com","tdbank.com","barclays.com","hsbc.com","santander.com","deutsche-bank.com","stripe.com","square.com","venmo.com","cashapp.com","coinbase.com","binance.com","kraken.com","gemini.com","ebay.com","walmart.com","target.com","bestbuy.com","netflix.com","hulu.com","disneyplus.com","spotify.com","instagram.com","tiktok.com","snapchat.com","reddit.com","yahoo.com","protonmail.com","zoho.com","aol.com"],m=["google","facebook","amazon","microsoft","apple","netflix","instagram","twitter","linkedin","youtube","tiktok","snapchat","reddit","discord","telegram","whatsapp","zoom","slack","github","gitlab","paypal","stripe","square","venmo","cashapp","coinbase","binance","kraken","gemini","robinhood","bankofamerica","chase","wellsfargo","citibank","usbank","pnc","capitalone","tdbank","bofa","citi","barclays","hsbc","santander","deutschebank","bnpparibas","creditsuis se","ing","natwest","lloydsbank","rbs","ebay","walmart","target","bestbuy","costco","homedepot","lowes","alibaba","aliexpress","etsy","spotify","hulu","disneyplus","hbomax","primevideo","twitch","vimeo","soundcloud","pandora","gmail","outlook","yahoo","protonmail","icloud","dropbox","onedrive","googledrive","icloud","box","steam","epicgames","playstation","xbox","nintendo","roblox","minecraft","fortnite","ea","ubisoft","irs","usps","fedex","ups","dhl","coursera","udemy","edx","khanacademy","duolingo","adobe","salesforce","shopify","wordpress","squarespace"],p=["bit.ly","tinyurl.com","goo.gl","t.co","ow.ly","is.gd","buff.ly","adf.ly","bit.do","short.link"],y={IP_ADDRESS:/^(?:\d{1,3}\.){3}\d{1,3}$/,SUSPICIOUS_CHARS:/[^a-zA-Z0-9.-]/,MULTIPLE_DOTS:/\.{2,}/,HYPHEN_SUBDOMAIN:/^[^.]*-[^.]*\./,ENCODED_CHARS:/%[0-9A-Fa-f]{2}/},f={SAFE:864e5,SUSPICIOUS:36e5,DANGEROUS:6048e5};class w{constructor(e){this.url=e,this.parsed=null,this.domain=null,this.hostname=null,this.protocol=null,this.parseURL()}parseURL(){try{this.parsed=new URL(this.url),this.hostname=this.parsed.hostname.toLowerCase(),this.domain=this.extractDomain(this.hostname),this.protocol=this.parsed.protocol,this.username=this.parsed.username}catch(e){console.error("Invalid URL:",this.url),this.parsed=null}}extractDomain(e){const t=e.split(".");return t.length>=2?t.slice(-2).join("."):e}isIPAddress(){return y.IP_ADDRESS.test(this.hostname)}hasSuspiciousTLD(){return d.some(e=>this.hostname.endsWith(e))}hasEncodedChars(){return y.ENCODED_CHARS.test(this.url)}hasMultipleDots(){return y.MULTIPLE_DOTS.test(this.hostname)}isURLShortener(){return p.some(e=>this.domain===e)}isLegitimate(){return g.some(e=>this.domain===e||this.hostname.endsWith(`.${e}`))}hasHomographAttack(){const e={a:["Ð°","É‘","Î±","áº¡","Äƒ","Ä…","Ã ","Ã¡","Ã¢","Ã£","Ã¤","Ã¥","Ä","È§","áº¥","áº§","áº©","áº«","áº­","áº¯","áº±","áº³","áºµ","áº·"],b:["Ð¬","ÑŒ","á¸ƒ","á¸…","á¸‡","Æ…"],c:["Ñ","Ï²","Ä‹","Ã§","Ä‡","Ä‰","Ä","á¸‰"],d:["Ô","á¸‹","á¸","á¸","á¸‘","á¸“","Ä","Ä‘"],e:["Ðµ","Îµ","Ä—","Ä™","Ã¨","Ã©","Ãª","Ã«","Ä“","Ä›","È©","á¸•","á¸—","á¸™","á¸›","á¸","áº¿","á»","á»ƒ","á»…","á»‡"],f:["á¸Ÿ","Æ’"],g:["Ä¡","Ä£","Ä","Ç§","Çµ","á¸¡"],h:["Ò»","á¸£","á¸¥","á¸§","á¸©","á¸«","Ä¥","Ä§"],i:["Ñ–","Î¹","1","l","|","Ä±","Ã¯","Ã¬","Ã­","Ã®","Ä©","Ä«","Ä­","Ä¯","Ç","È‰","È‹","á¸­","á¸¯","á»‰","á»‹"],j:["Ñ˜","Äµ","Ç°"],k:["Ðº","Ä·","á¸±","á¸³","á¸µ"],l:["Ó","1","I","|","Äº","Ä¼","Ä¾","á¸·","á¸¹","á¸»","á¸½","Å‚"],m:["Ð¼","á¹","á¹ƒ"],n:["Õ¸","á¹…","á¹‡","á¹‰","á¹‹","Å„","Å†","Åˆ","Ã±","Ç¹","Èµ"],o:["Ð¾","Î¿","0","È¯","á»","á»","Å","Å","Å‘","Ã²","Ã³","Ã´","Ãµ","Ã¶","Æ¡","Ç’","Ç«","Ç­","È","È","È«","È­","È¯","È±","á¹","á¹","á¹‘","á¹“","á»‘","á»“","á»•","á»—","á»™","á»›","á»","á»Ÿ","á»¡","á»£"],p:["Ñ€","Ï","á¹•","á¹—"],q:["Ô›","Õ¦"],r:["Ð³","á¹™","á¹›","á¹","á¹Ÿ","Å•","Å—","Å™","È‘","È“"],s:["Ñ•","Å›","á¹¡","á¹£","á¹¥","á¹§","á¹©","Å","Å¡","È™"],t:["Ñ‚","á¹«","á¹­","á¹¯","á¹±","Å£","Å¥","È›"],u:["Ï…","Õ½","Ã¼","Ã¹","Ãº","Ã»","Å©","Å«","Å­","Å¯","Å±","Å³","Æ°","Ç”","Ç–","Ç˜","Çš","Çœ","È•","È—","á»¥","á»§","á»©","á»«","á»­","á»¯","á»±"],v:["Î½","v","á¹½","á¹¿"],w:["Ñ¡","áº","áºƒ","áº…","áº‡","áº‰","Åµ"],x:["Ñ…","Ï‡","áº‹","áº"],y:["Ñƒ","Î³","á»³","Ã½","Å·","Ã¿","È³","áº","á»µ","á»·","á»¹"],z:["Åº","Å¼","Å¾","áº‘","áº“","áº•"]};for(const[t,s]of Object.entries(e))for(const e of s)if(this.hostname.includes(e))return!0;return this.detectMixedScripts(this.hostname).size>1}detectMixedScripts(e){const t=new Set;for(const s of e){const e=s.charCodeAt(0);e>=65&&e<=90||e>=97&&e<=122?t.add("Latin"):e>=1024&&e<=1279?t.add("Cyrillic"):e>=880&&e<=1023?t.add("Greek"):e>=1328&&e<=1423&&t.add("Armenian")}return t}isTyposquatting(){for(const e of m)if(this.hostname.includes(e)){const t=[".com",".net",".org",".co",".io"];for(const s of t){const t=`${e}${s}`;if(this.domain!==t&&this.hostname!==t){const e=this.levenshteinDistance(this.domain,t);if(e>0&&e<=2)return!0}}if(this.hasCharacterSubstitution(e))return!0}return!1}hasCharacterSubstitution(e){const t={a:["4","@"],e:["3"],i:["1","l","!"],o:["0"],s:["5","$"],l:["1","i"],t:["7"]};for(const[s,a]of Object.entries(t))for(const t of a){const a=e.replace(new RegExp(s,"g"),t);if(this.hostname.includes(a))return!0}return!1}levenshteinDistance(e,t){const s=[];for(let e=0;e<=t.length;e++)s[e]=[e];for(let t=0;t<=e.length;t++)s[0][t]=t;for(let a=1;a<=t.length;a++)for(let r=1;r<=e.length;r++)t.charAt(a-1)===e.charAt(r-1)?s[a][r]=s[a-1][r-1]:s[a][r]=Math.min(s[a-1][r-1]+1,s[a][r-1]+1,s[a-1][r]+1);return s[t.length][e.length]}hasLongDomain(){return this.hostname.length>50}hasNonStandardPort(){const e=this.parsed?.port;return!!e&&!["80","443","8080","8443"].includes(e)}isInsecure(){return"http:"===this.protocol}hasDangerousScheme(){return["javascript:","data:","blob:","file:","vbscript:"].some(e=>this.protocol===e)}hasUsernameInURL(){return this.username&&this.username.length>0}hasSubdomainImpersonation(){const e=["paypal","amazon","google","microsoft","apple","facebook","netflix","instagram","twitter","linkedin","bankofamerica","chase","wellsfargo","citibank"];for(const t of e)if(this.hostname.includes(t)&&!this.domain.startsWith(t))return!0;return!1}hasPathSpoofing(){const e=this.parsed?.pathname||"";return["paypal.com","amazon.com","google.com","microsoft.com","apple.com","facebook.com","netflix.com","bankofamerica.com","chase.com","wellsfargo.com"].some(t=>e.includes(t))}hasDoubleEncoding(){return/%25/.test(this.url)}hasPunycode(){return/xn--/.test(this.hostname)}getIssues(){const e=[];return this.parsed?(this.hasDangerousScheme()&&e.push({type:"dangerous_scheme",severity:"high",message:"URL uses dangerous protocol (javascript/data/blob/file)"}),this.hasUsernameInURL()&&e.push({type:"username_in_url",severity:"high",message:"URL contains username (common phishing technique)"}),this.hasSubdomainImpersonation()&&e.push({type:"subdomain_impersonation",severity:"high",message:"Popular brand appears as subdomain (spoofing attempt)"}),this.hasPathSpoofing()&&e.push({type:"path_spoofing",severity:"high",message:"Trusted domain name appears in URL path (deception technique)"}),this.hasDoubleEncoding()&&e.push({type:"double_encoding",severity:"high",message:"URL contains double-encoded characters (obfuscation attempt)"}),this.hasPunycode()&&e.push({type:"punycode",severity:"medium",message:"URL uses internationalized domain name (possible homograph attack)"}),this.isIPAddress()&&e.push({type:"ip_address",severity:"high",message:"URL uses IP address instead of domain name"}),this.hasSuspiciousTLD()&&e.push({type:"suspicious_tld",severity:"medium",message:"URL uses a suspicious top-level domain"}),this.hasEncodedChars()&&e.push({type:"encoded_chars",severity:"medium",message:"URL contains encoded characters"}),this.hasMultipleDots()&&e.push({type:"multiple_dots",severity:"low",message:"URL has unusual dot patterns"}),this.isURLShortener()&&e.push({type:"url_shortener",severity:"low",message:"URL is shortened (destination unknown)"}),this.hasHomographAttack()&&e.push({type:"homograph",severity:"high",message:"URL contains lookalike characters"}),this.isTyposquatting()&&e.push({type:"typosquatting",severity:"high",message:"URL appears to mimic a popular domain"}),this.hasLongDomain()&&e.push({type:"long_domain",severity:"low",message:"URL has an unusually long domain"}),this.hasNonStandardPort()&&e.push({type:"non_standard_port",severity:"medium",message:"URL uses non-standard port"}),this.isInsecure()&&e.push({type:"insecure",severity:"medium",message:"URL uses insecure HTTP protocol"}),e):(e.push({type:"invalid_url",severity:"high",message:"Invalid URL format"}),e)}getThreatLevel(){const e=this.getIssues();if(this.isLegitimate())return"safe";const t=e.filter(e=>"high"===e.severity).length,s=e.filter(e=>"medium"===e.severity).length;return t>=2||t>=1&&s>=1?"dangerous":t>=1||s>=2||e.length>0?"suspicious":"unknown"}}function k(e){const t=new w(e);return{url:e,domain:t.domain,hostname:t.hostname,threatLevel:t.getThreatLevel(),issues:t.getIssues(),isLegitimate:t.isLegitimate()}}class b{static async getSettings(){try{return(await chrome.storage.sync.get(o))[o]||l}catch(e){return console.error("Error getting settings:",e),l}}static async saveSettings(e){try{return await chrome.storage.sync.set({[o]:{...l,...e}}),!0}catch(e){return console.error("Error saving settings:",e),!1}}static async getWhitelist(){try{return(await chrome.storage.sync.get(r))[r]||[]}catch(e){return console.error("Error getting whitelist:",e),[]}}static async addToWhitelist(e){try{const t=await this.getWhitelist();return t.includes(e)||(t.push(e),await chrome.storage.sync.set({[r]:t})),!0}catch(e){return console.error("Error adding to whitelist:",e),!1}}static async removeFromWhitelist(e){try{const t=(await this.getWhitelist()).filter(t=>t!==e);return await chrome.storage.sync.set({[r]:t}),!0}catch(e){return console.error("Error removing from whitelist:",e),!1}}static async isWhitelisted(e){return(await this.getWhitelist()).some(t=>e.includes(t)||t.includes(e))}static async getBlacklist(){try{return(await chrome.storage.sync.get(i))[i]||[]}catch(e){return console.error("Error getting blacklist:",e),[]}}static async addToBlacklist(e){try{const t=await this.getBlacklist();return t.includes(e)||(t.push(e),await chrome.storage.sync.set({[i]:t})),!0}catch(e){return console.error("Error adding to blacklist:",e),!1}}static async removeFromBlacklist(e){try{const t=(await this.getBlacklist()).filter(t=>t!==e);return await chrome.storage.sync.set({[i]:t}),!0}catch(e){return console.error("Error removing from blacklist:",e),!1}}static async isBlacklisted(e){return(await this.getBlacklist()).some(t=>e.includes(t)||t.includes(e))}static async getCachedThreat(e){try{const t=(await chrome.storage.local.get(n))[n]||{},s=t[e];if(!s)return null;return Date.now()-s.timestamp>(f[s.threatLevel.toUpperCase()]||f.SUSPICIOUS)?(delete t[e],await chrome.storage.local.set({[n]:t}),null):s}catch(e){return console.error("Error getting cached threat:",e),null}}static async cacheThreat(e,t){try{const s=(await chrome.storage.local.get(n))[n]||{};s[e]={...t,timestamp:Date.now()};const a=Object.entries(s);if(a.length>1e3){a.sort((e,t)=>e[1].timestamp-t[1].timestamp);const e=a.slice(-1e3),t=Object.fromEntries(e);await chrome.storage.local.set({[n]:t})}else await chrome.storage.local.set({[n]:s});return!0}catch(e){return console.error("Error caching threat:",e),!1}}static async clearCache(){try{return await chrome.storage.local.set({[n]:{}}),!0}catch(e){return console.error("Error clearing cache:",e),!1}}static async getStats(){try{return(await chrome.storage.local.get(c))[c]||{linksScanned:0,threatsBlocked:0,lastScan:null}}catch(e){return console.error("Error getting stats:",e),{linksScanned:0,threatsBlocked:0,lastScan:null}}}static async updateStats(e){try{const t={...await this.getStats(),...e};return await chrome.storage.local.set({[c]:t}),!0}catch(e){return console.error("Error updating stats:",e),!1}}static async incrementScanned(){const e=await this.getStats();await this.updateStats({linksScanned:e.linksScanned+1,lastScan:(new Date).toISOString()})}static async incrementBlocked(){const e=await this.getStats();await this.updateStats({threatsBlocked:e.threatsBlocked+1})}static async resetStats(){try{return await chrome.storage.local.set({[c]:{linksScanned:0,threatsBlocked:0,lastScan:null}}),!0}catch(e){return console.error("Error resetting stats:",e),!1}}}class v{static async showThreatBlocked(e,t,s){const a=new URL(e).hostname;let r,i,o;switch(t){case"dangerous":r="ðŸ›¡ï¸ DANGEROUS THREAT BLOCKED!",i=`Blocked phishing attempt from ${a}\n${s} security issues detected.`,o="/icons/icon48.png";break;case"suspicious":r="âš ï¸ Suspicious Link Detected",i=`Warning: ${a} shows ${s} suspicious indicators.`,o="/icons/icon48.png";break;default:return}try{await chrome.notifications.create({type:"basic",iconUrl:o,title:r,message:i,priority:"dangerous"===t?2:1,requireInteraction:"dangerous"===t})}catch(e){console.error("Failed to show notification:",e)}}static async showReportSubmitted(e){try{await chrome.notifications.create({type:"basic",iconUrl:"/icons/icon48.png",title:"âœ… Report Submitted",message:`Thank you! Your ${e} report has been recorded.`,priority:0})}catch(e){console.error("Failed to show notification:",e)}}static async showProtectionSummary(e){const{linksScanned:t,threatsBlocked:s}=e;try{await chrome.notifications.create({type:"basic",iconUrl:"/icons/icon48.png",title:"ðŸ›¡ï¸ Protection Summary",message:`This week: ${t} links scanned, ${s} threats blocked!`,priority:0})}catch(e){console.error("Failed to show notification:",e)}}static async showWhitelistWarning(e){try{await chrome.notifications.create({type:"basic",iconUrl:"/icons/icon48.png",title:"âš ï¸ Whitelisted Domain Compromised",message:`Warning: ${e} was removed from whitelist due to security concerns.`,priority:2,requireInteraction:!0})}catch(e){console.error("Failed to show notification:",e)}}}class S{static async getAnalytics(){try{const e=await b.getStats(),t=await b.getWhitelist(),s=await b.getBlacklist(),a=await this.getThreatBreakdown(),r=e.linksScanned>0?(e.threatsBlocked/e.linksScanned*100).toFixed(2):0,i=await this.getDailyStats(),o=await this.getWeeklyStats();return{overview:{linksScanned:e.linksScanned||0,threatsBlocked:e.threatsBlocked||0,protectionRate:r,whitelistCount:t.length,blacklistCount:s.length,lastScan:e.lastScan||null},threatBreakdown:a,daily:i,weekly:o,timestamp:Date.now()}}catch(e){return console.error("Error getting analytics:",e),null}}static async getThreatBreakdown(){try{return(await chrome.storage.local.get("threatBreakdown")).threatBreakdown||{dangerous:0,suspicious:0,safe:0,unknown:0,byType:{phishing:0,typosquatting:0,homograph:0,spam:0,malicious_scheme:0,ip_address:0,suspicious_tld:0,url_shortener:0}}}catch(e){return console.error("Error getting threat breakdown:",e),null}}static async recordThreat(e,t){try{const s=await this.getThreatBreakdown();return"dangerous"===e?s.dangerous++:"suspicious"===e?s.suspicious++:"safe"===e?s.safe++:s.unknown++,t.forEach(e=>{e.includes("typosquatting")?s.byType.typosquatting++:e.includes("homograph")?s.byType.homograph++:e.includes("spam")||e.includes("suspicious_context")?s.byType.spam++:e.includes("dangerous_scheme")?s.byType.malicious_scheme++:e.includes("ip_address")?s.byType.ip_address++:e.includes("suspicious_tld")?s.byType.suspicious_tld++:e.includes("url_shortener")?s.byType.url_shortener++:s.byType.phishing++}),await chrome.storage.local.set({threatBreakdown:s}),await this.recordDailyActivity(e),s}catch(e){return console.error("Error recording threat:",e),null}}static async getDailyStats(){try{return(await chrome.storage.local.get("dailyStats")).dailyStats||[]}catch(e){return console.error("Error getting daily stats:",e),[]}}static async recordDailyActivity(e){try{const t=await this.getDailyStats(),s=(new Date).toDateString();let a=t.find(e=>e.date===s);return a||(a={date:s,scanned:0,blocked:0,dangerous:0,suspicious:0},t.push(a)),a.scanned++,"dangerous"===e?(a.blocked++,a.dangerous++):"suspicious"===e&&a.suspicious++,t.length>30&&t.shift(),await chrome.storage.local.set({dailyStats:t}),t}catch(e){return console.error("Error recording daily activity:",e),null}}static async getWeeklyStats(){try{const e=(await this.getDailyStats()).slice(-7),t={scanned:0,blocked:0,dangerous:0,suspicious:0};return e.forEach(e=>{t.scanned+=e.scanned||0,t.blocked+=e.blocked||0,t.dangerous+=e.dangerous||0,t.suspicious+=e.suspicious||0}),t}catch(e){return console.error("Error getting weekly stats:",e),{scanned:0,blocked:0,dangerous:0,suspicious:0}}}static async exportAnalytics(){try{const e=await this.getAnalytics(),t={exportDate:(new Date).toISOString(),version:"1.0.0",analytics:e},s=JSON.stringify(t,null,2),a=new Blob([s],{type:"application/json"});return{success:!0,url:URL.createObjectURL(a),filename:`apg-analytics-${Date.now()}.json`}}catch(e){return console.error("Error exporting analytics:",e),{success:!1,error:e.message}}}static async resetAnalytics(){try{return await chrome.storage.local.remove(["threatBreakdown","dailyStats"]),await b.resetStats(),{success:!0,message:"Analytics reset successfully."}}catch(e){return console.error("Error resetting analytics:",e),{success:!1,error:e.message}}}}class T{static async handle(e,t={}){const s={message:e.message||"Unknown error",stack:e.stack,timestamp:(new Date).toISOString(),context:t,userAgent:navigator.userAgent,extensionVersion:chrome.runtime.getManifest().version};return console.error("[APG Error]",s),await this.logError(s),this.getUserFriendlyMessage(e,t)}static getUserFriendlyMessage(e,t){const s=t.operation||"operation";return e.message.includes("fetch")||e.message.includes("network")?{title:"Connection Error",message:`Unable to ${s}. Please check your internet connection and try again.`,action:"Retry",severity:"warning"}:e.message.includes("storage")||e.message.includes("quota")?{title:"Storage Error",message:"Not enough storage space. Please clear some data or increase storage limit.",action:"Clear Cache",severity:"error"}:e.message.includes("permission")?{title:"Permission Required",message:`Extension needs additional permissions to ${s}. Please grant permissions and try again.`,action:"Grant Permissions",severity:"warning"}:e.message.includes("Invalid URL")?{title:"Invalid Link",message:"The link format is not recognized. Unable to analyze this URL.",action:"Dismiss",severity:"info"}:"update threat database"===t.operation?{title:"Database Update Failed",message:"Unable to update threat database. The extension will continue using cached data.",action:"Retry Later",severity:"warning"}:{title:"Something Went Wrong",message:`Unable to ${s}. Please try again. If the problem persists, try restarting the extension.`,action:"Retry",severity:"error"}}static async logError(e){try{const t=(await chrome.storage.local.get("errorLogs")).errorLogs||[];t.push(e),t.length>50&&t.splice(0,t.length-50),await chrome.storage.local.set({errorLogs:t})}catch(e){console.error("[APG] Failed to log error:",e)}}static async getErrorLogs(){try{return(await chrome.storage.local.get("errorLogs")).errorLogs||[]}catch(e){return console.error("[APG] Failed to get error logs:",e),[]}}static async clearErrorLogs(){try{return await chrome.storage.local.remove("errorLogs"),{success:!0}}catch(e){return console.error("[APG] Failed to clear error logs:",e),{success:!1,error:e.message}}}static async retryOperation(e,t=3,s=1e3){let a;for(let r=0;r<t;r++)try{return await e()}catch(e){if(a=e,r<t-1){const e=s*Math.pow(2,r);console.log(`[APG] Retry attempt ${r+1}/${t} after ${e}ms`),await new Promise(t=>setTimeout(t,e))}}throw a}static async safeAsync(e,t={},s=null){try{return await e()}catch(e){const a=await this.handle(e,t);try{await chrome.notifications.create({type:"basic",iconUrl:"/icons/icon48.png",title:a.title,message:a.message,priority:"error"===a.severity?2:1})}catch(e){console.error("[APG] Failed to show error notification:",e)}return s}}static validateURL(e){try{const t=new URL(e);if(!["http:","https:","ftp:","mailto:"].includes(t.protocol))throw new Error(`Invalid protocol: ${t.protocol}`);return{valid:!0,url:t.href}}catch(e){return{valid:!1,error:"Invalid URL format",message:"Please enter a valid URL (e.g., https://example.com)"}}}static async checkHealth(){const e={storage:!1,permissions:!1,database:!1,timestamp:Date.now()};try{await chrome.storage.local.get("test"),e.storage=!0}catch(e){console.error("[APG Health] Storage check failed:",e)}try{const t=await chrome.permissions.contains({permissions:["storage","notifications","alarms"]});e.permissions=t}catch(e){console.error("[APG Health] Permissions check failed:",e)}try{const t=await chrome.storage.local.get("phishTankDB");e.database=!!t.phishTankDB}catch(e){console.error("[APG Health] Database check failed:",e)}return e}}"undefined"!=typeof window&&(window.addEventListener("error",e=>{T.handle(e.error,{operation:"global error",filename:e.filename,lineno:e.lineno,colno:e.colno})}),window.addEventListener("unhandledrejection",e=>{T.handle(e.reason,{operation:"unhandled promise rejection"})}));class L{static worker=null;static isReady=!1;static pendingCallbacks=new Map;static callbackId=0;static async initialize(){if(!this.worker)try{this.worker=new Worker(chrome.runtime.getURL("phishtank-worker.js")),this.worker.onmessage=e=>this.handleMessage(e),this.worker.onerror=e=>{console.error("[Worker] Error:",e),this.isReady=!1},await this.waitForReady(),console.log("[Worker] Initialized successfully")}catch(e){throw console.error("[Worker] Failed to initialize:",e),e}}static waitForReady(){return new Promise(e=>{this.worker?this.worker.addEventListener("message",t=>{"ready"===t.data.action&&(this.isReady=!0,e())},{once:!0}):e()})}static async loadDatabase(e){return this.worker&&this.isReady||await this.initialize(),new Promise((t,s)=>{const a=this.callbackId++;this.pendingCallbacks.set(a,{resolve:t,reject:s}),this.worker.postMessage({id:a,action:"loadDatabase",data:{urls:e}}),setTimeout(()=>{this.pendingCallbacks.has(a)&&(this.pendingCallbacks.delete(a),s(new Error("Worker timeout")))},3e4)})}static async checkUrl(e){return this.worker&&this.isReady?new Promise(t=>{const s=this.callbackId++;this.pendingCallbacks.set(s,{resolve:t,reject:t}),this.worker.postMessage({id:s,action:"checkUrl",data:{url:e}}),setTimeout(()=>{this.pendingCallbacks.has(s)&&(this.pendingCallbacks.delete(s),t({found:!1,error:"Timeout"}))},5e3)}):{found:!1,error:"Worker not available"}}static async checkBatch(e){return this.worker&&this.isReady?new Promise(t=>{const s=this.callbackId++;this.pendingCallbacks.set(s,{resolve:t,reject:t}),this.worker.postMessage({id:s,action:"checkBatch",data:{urls:e}}),setTimeout(()=>{this.pendingCallbacks.has(s)&&(this.pendingCallbacks.delete(s),t(e.map(e=>({url:e,result:{found:!1}}))))},1e4)}):e.map(e=>({url:e,result:{found:!1}}))}static handleMessage(e){const{id:t,action:s,data:a}=e.data;if("databaseLoaded"!==s){if("checkResult"!==s){if("batchResults"!==s){if("error"===s&&(console.error("[Worker] Error:",a),this.pendingCallbacks.has(t))){const{reject:e}=this.pendingCallbacks.get(t);this.pendingCallbacks.delete(t),e(new Error(a.message||"Worker error"))}}else if(this.pendingCallbacks.has(t)){const{resolve:e}=this.pendingCallbacks.get(t);this.pendingCallbacks.delete(t),e(a)}}else if(this.pendingCallbacks.has(t)){const{resolve:e}=this.pendingCallbacks.get(t);this.pendingCallbacks.delete(t),e(a)}}else if(console.log(`[Worker] Database loaded: ${a.count} threats`),this.pendingCallbacks.has(t)){const{resolve:e}=this.pendingCallbacks.get(t);this.pendingCallbacks.delete(t),e(a)}}static terminate(){this.worker&&(this.worker.terminate(),this.worker=null,this.isReady=!1,this.pendingCallbacks.clear(),console.log("[Worker] Terminated"))}}class D{static async updatePhishTankDatabase(){return await T.safeAsync(async()=>{let e;console.log("[TI] Downloading PhishTank database...");try{e=await T.retryOperation(async()=>{const e=await fetch("https://data.phishtank.com/data/online-valid.json",{method:"GET",headers:{Accept:"application/json"},mode:"cors"});if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);return e},2,1e3)}catch(e){return console.warn("[TI] PhishTank CORS blocked, using fallback minimal database"),{success:!0,count:this.getFallbackPhishingData().length,timestamp:Date.now(),source:"fallback",message:"Using built-in phishing patterns (PhishTank unavailable due to CORS)"}}const t=await e.json(),s=this.validatePhishTankData(t);if(!s||0===s.length)throw new Error("No valid PhishTank data after validation");const a=[];let r=0;for(const e of s)try{if(!e||"object"!=typeof e){r++;continue}if(!e.url||"string"!=typeof e.url){r++;continue}const t=this.sanitizePhishTankURL(e.url);if(!t){r++;continue}const s=new URL(t).hostname;if(!this.isValidDomain(s)){r++;continue}a.push({url:t,domain:s,verified:"yes"===e.verified||!0===e.verified,timestamp:this.validateTimestamp(e.submission_time)})}catch(e){r++;continue}if(console.log(`[TI] Processed ${a.length} valid URLs, skipped ${r} invalid entries`),0===a.length)throw new Error("No valid URLs extracted from PhishTank data");await chrome.storage.local.set({phishTankDB:{urls:a,lastUpdated:Date.now(),count:a.length}}),console.log(`[TI] PhishTank database updated: ${a.length} threats`);try{await L.loadDatabase(a),console.log("[TI] Database loaded into worker")}catch(e){console.warn("[TI] Worker load failed, will use fallback:",e)}return await v.showProtectionSummary({linksScanned:0,threatsBlocked:0,message:`Threat database updated: ${a.length} known threats`}),{success:!0,count:a.length,timestamp:Date.now()}},{operation:"update threat database"},{success:!1,error:"Failed to update database after multiple attempts"})}static validatePhishTankData(e){if(!Array.isArray(e))throw new Error("PhishTank data is not an array");const t=1e5;if(e.length>t)return console.warn(`[TI Security] PhishTank data too large (${e.length}), truncating to 100000`),e.slice(0,t);if(0===e.length)throw new Error("PhishTank data is empty");return e}static sanitizePhishTankURL(e){if(!e||"string"!=typeof e)return null;const t=e.trim().substring(0,2048);if(!t.startsWith("http://")&&!t.startsWith("https://"))return null;if(/[\x00-\x1F\x7F]/.test(t))return null;try{const e=new URL(t);return["data:","javascript:","file:","vbscript:"].includes(e.protocol)?null:t}catch{return null}}static isValidDomain(e){return!(!e||"string"!=typeof e)&&(!(e.length>253||e.length<3)&&/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?(\.[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?)*$/i.test(e))}static validateTimestamp(e){if(!e)return Date.now();if("string"==typeof e){const t=Date.parse(e);if(!isNaN(t)){const e=Date.now();if(t>=e-31536e7&&t<=e+31536e6)return t}}if("number"==typeof e){const t=Date.now();if(e>=t-31536e7&&e<=t+31536e6)return e}return Date.now()}static async checkPhishTank(e){try{try{const t=await L.checkUrl(e);if(t&&!t.error)return t}catch(e){console.warn("[TI] Worker check failed, using fallback:",e)}const t=await chrome.storage.local.get("phishTankDB");if(!t.phishTankDB)return await this.updatePhishTankDatabase(),{found:!1,needsUpdate:!0};const{urls:s,lastUpdated:a}=t.phishTankDB;Date.now()-a>864e5&&this.updatePhishTankDatabase();const r=e.toLowerCase().replace(/\/$/,""),i=new URL(e).hostname,o=s.find(e=>e.url.toLowerCase()===r||e.domain===i);return o?{found:!0,verified:o.verified,timestamp:o.timestamp,source:"PhishTank"}:{found:!1}}catch(e){return console.error("[TI] Error checking PhishTank:",e),{found:!1,error:e.message}}}static async getDatabaseStats(){try{const e=await chrome.storage.local.get("phishTankDB");if(!e.phishTankDB)return{exists:!1,count:0,lastUpdated:null,age:null};const{count:t,lastUpdated:s}=e.phishTankDB,a=Date.now()-s,r=Math.floor(a/36e5);return{exists:!0,count:t,lastUpdated:new Date(s).toLocaleString(),age:a,hoursOld:r,needsUpdate:a>864e5}}catch(e){return console.error("[TI] Error getting database stats:",e),{exists:!1,error:e.message}}}static scheduleAutomaticUpdates(){this.updatePhishTankDatabase(),chrome.alarms.create("updatePhishTank",{periodInMinutes:1440}),chrome.alarms.onAlarm.addListener(e=>{"updatePhishTank"===e.name&&(console.log("[TI] Automatic PhishTank update triggered"),this.updatePhishTankDatabase())})}static async clearDatabase(){try{return await chrome.storage.local.remove("phishTankDB"),{success:!0,message:"Threat database cleared"}}catch(e){return console.error("[TI] Error clearing database:",e),{success:!1,error:e.message}}}static getFallbackPhishingData(){const e=[],t=Date.now(),s=[{domain:"secure-login-verify.tk",url:"http://secure-login-verify.tk"},{domain:"account-verify-secure.ml",url:"http://account-verify-secure.ml"},{domain:"banking-secure-login.ga",url:"http://banking-secure-login.ga"},{domain:"microsoft-support-alert.xyz",url:"http://microsoft-support-alert.xyz"},{domain:"apple-security-alert.top",url:"http://apple-security-alert.top"},{domain:"verify-account-now.club",url:"http://verify-account-now.club"},{domain:"secure-update-required.work",url:"http://secure-update-required.work"}];for(const a of s)e.push({url:a.url,domain:a.domain,verified:!0,timestamp:t});return console.log(`[TI] Using fallback database with ${e.length} patterns`),console.warn("[TI] âš ï¸ RECOMMENDATION: Consider using Supabase for reliable phishing database access"),console.warn("[TI] PhishTank API blocks browser extensions due to CORS policy"),chrome.storage.local.set({phishTankDB:{urls:e,lastUpdated:t,count:e.length,source:"fallback"}}),e}}class U{static validateURL(e){const t=[];try{const s=new URL(e);"http:"===s.protocol&&t.push({type:"insecure_protocol",severity:"high",message:"Insecure HTTP connection (not encrypted)",recommendation:"Always use HTTPS for sensitive data"});const a="localhost"===s.hostname||"127.0.0.1"===s.hostname||s.hostname.endsWith(".local");if(a&&"http:"===s.protocol){const e=t[t.length-1];e&&"insecure_protocol"===e.type&&(e.severity="low",e.message="HTTP on localhost (acceptable for development)")}return"undefined"!=typeof window&&"https:"===window.location.protocol&&"http:"===s.protocol&&t.push({type:"mixed_content",severity:"high",message:"HTTP resource on HTTPS page (blocked by browser)",recommendation:"Use HTTPS version of this resource"}),[21,23,25,110,143,445,3389].includes(s.port?parseInt(s.port):0)&&t.push({type:"dangerous_port",severity:"high",message:`Suspicious port ${s.port} (commonly used for attacks)`,recommendation:"Avoid clicking links with unusual ports"}),s.searchParams.has("ssl")&&"false"===s.searchParams.get("ssl")&&t.push({type:"ssl_disabled",severity:"high",message:"SSL explicitly disabled in URL parameters",recommendation:"Do not proceed with this link"}),{secure:0===t.filter(e=>"high"===e.severity).length,issues:t,protocol:s.protocol,isHTTPS:"https:"===s.protocol,isLocalhost:a}}catch(e){return{secure:!1,issues:[{type:"validation_error",severity:"medium",message:"Unable to validate URL security",error:e.message}],protocol:null,isHTTPS:!1}}}static async checkCertificateErrors(e){try{if("https:"!==new URL(e).protocol)return{hasCertError:!1,reason:"Not HTTPS"};const t=new AbortController,s=setTimeout(()=>t.abort(),5e3);try{return await fetch(e,{method:"HEAD",mode:"no-cors",signal:t.signal}),clearTimeout(s),{hasCertError:!1,valid:!0}}catch(e){clearTimeout(s);const t=["ERR_CERT_","ERR_SSL_","certificate","SSL","TLS"],a=e.message||"";return t.some(e=>a.includes(e))?{hasCertError:!0,error:"SSL/TLS certificate error detected",details:a}:{hasCertError:!1,error:"Network error (not SSL-related)",details:a}}}catch(e){return{hasCertError:!1,error:"Unable to check certificate",details:e.message}}}static getSecurityRecommendations(e){const t=this.validateURL(e),s=[];return t.isHTTPS||t.isLocalhost||s.push({priority:"high",message:"Always look for HTTPS (padlock icon) in browser",icon:"ðŸ”’"}),t.issues.some(e=>"mixed_content"===e.type)&&s.push({priority:"high",message:"Mixed content can expose sensitive data",icon:"âš ï¸"}),t.issues.some(e=>"dangerous_port"===e.type)&&s.push({priority:"high",message:"Unusual ports often indicate malicious links",icon:"ðŸš¨"}),s}static formatResults(e){const t=e.issues.filter(e=>"high"===e.severity),s=e.issues.filter(e=>"medium"===e.severity),a=e.issues.filter(e=>"low"===e.severity);return{...e,summary:{total:e.issues.length,high:t.length,medium:s.length,low:a.length},status:e.secure?"secure":"insecure",icon:e.secure?"ðŸ”’":"ðŸ”“"}}}class P{static extractFeatures(e){try{const t=new URL(e);return{urlLength:e.length,domainLength:t.hostname.length,pathLength:t.pathname.length,paramCount:t.searchParams.size,digitCount:(e.match(/\d/g)||[]).length,specialCharCount:(e.match(/[^a-zA-Z0-9]/g)||[]).length,uppercaseCount:(e.match(/[A-Z]/g)||[]).length,subdomainCount:t.hostname.split(".").length-2,hasDash:t.hostname.includes("-"),hasUnderscore:t.hostname.includes("_"),hasIP:/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/.test(t.hostname),hasPort:""!==t.port,hasAtSymbol:e.includes("@"),isHTTPS:"https:"===t.protocol,tld:t.hostname.split(".").pop(),isCommonTLD:["com","org","net","edu","gov"].includes(t.hostname.split(".").pop()),entropy:this.calculateEntropy(t.hostname),suspiciousKeywords:this.countSuspiciousKeywords(e)}}catch(e){return null}}static calculateEntropy(e){const t=e.length,s={};for(let a=0;a<t;a++){const t=e[a];s[t]=(s[t]||0)+1}let a=0;for(const e in s){const r=s[e]/t;a-=r*Math.log2(r)}return a}static countSuspiciousKeywords(e){const t=["login","signin","account","verify","secure","update","confirm","banking","paypal","amazon","microsoft","apple","password","suspended","locked","urgent","alert"],s=e.toLowerCase();let a=0;for(const e of t)s.includes(e)&&a++;return a}static calculatePhishingScore(e){if(!e)return 0;let t=0;return e.urlLength>75&&(t+=2),e.urlLength>100&&(t+=3),e.domainLength>30&&(t+=2),e.digitCount>8&&(t+=2),e.specialCharCount>10&&(t+=2),e.uppercaseCount>.5*e.domainLength&&(t+=1),e.subdomainCount>3&&(t+=3),e.hasDash&&(t+=1),e.hasUnderscore&&(t+=2),e.hasIP&&(t+=5),e.hasPort&&(t+=2),e.hasAtSymbol&&(t+=4),e.isHTTPS||(t+=3),e.isCommonTLD||(t+=2),["tk","ml","ga","cf","gq","top","xyz"].includes(e.tld)&&(t+=3),e.entropy>4.5&&(t+=2),e.entropy>5&&(t+=3),t+=2*e.suspiciousKeywords,Math.min(t,100)}static classify(e){return e>=15?{classification:"phishing",confidence:Math.min(e/20,1),threatLevel:"DANGEROUS"}:e>=8?{classification:"suspicious",confidence:e/15,threatLevel:"SUSPICIOUS"}:e>=4?{classification:"potentially_suspicious",confidence:e/10,threatLevel:"SUSPICIOUS"}:{classification:"legitimate",confidence:1-e/10,threatLevel:"SAFE"}}static matchKnownPatterns(e){const t=[{regex:/(login|signin).*\.(tk|ml|ga|cf|gq)/i,score:10,description:"Fake login page pattern"},{regex:/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}.*(login|account|verify)/i,score:15,description:"IP-based phishing page"},{regex:/(paypal|amazon|microsoft|apple|google).*\.(tk|ml|ga|xyz)/i,score:12,description:"Brand impersonation on suspicious TLD"},{regex:/[a-z0-9-]+\.[a-z0-9-]+\.[a-z0-9-]+\.(paypal|amazon|microsoft)/i,score:8,description:"Suspicious subdomain structure"},{regex:/(secure|verify|update).*\d{3,}/i,score:6,description:"Potential data collection page"}];let s=0;const a=[];for(const r of t)r.regex.test(e)&&(s+=r.score,a.push({description:r.description,score:r.score}));return{score:s,matches:a,hasMatch:a.length>0}}static analyze(e){const t=this.extractFeatures(e);if(!t)return{score:0,classification:"error",confidence:0,features:null};const s=this.calculatePhishingScore(t),a=this.matchKnownPatterns(e),r=s+a.score,i=this.classify(r);return{score:r,baseScore:s,patternScore:a.score,classification:i.classification,confidence:i.confidence,threatLevel:i.threatLevel,features:t,patterns:a.matches,analysis:{urlLength:t.urlLength>75?"suspicious":"normal",domainComplexity:t.subdomainCount>2?"high":"normal",hasIPAddress:t.hasIP,entropy:t.entropy>4.5?"high":"normal",suspiciousKeywords:t.suspiciousKeywords}}}static async updateWeights(e,t){try{const s={url:e,timestamp:Date.now(),actualThreat:t,features:this.extractFeatures(e)},a=(await chrome.storage.local.get("mlFeedback")).mlFeedback||[];return a.push(s),a.length>1e3&&a.shift(),await chrome.storage.local.set({mlFeedback:a}),{success:!0}}catch(e){return console.error("[ML] Error storing feedback:",e),{success:!1}}}static async getModelStats(){try{const e=(await chrome.storage.local.get("mlFeedback")).mlFeedback||[],t=e.filter(e=>"DANGEROUS"===e.actualThreat).length,s=e.filter(e=>"SUSPICIOUS"===e.actualThreat).length,a=e.filter(e=>"SAFE"===e.actualThreat).length;return{totalSamples:e.length,phishing:t,suspicious:s,safe:a,accuracy:e.length>0?((t+a)/e.length*100).toFixed(1):0}}catch(e){return{totalSamples:0,error:e.message}}}}class E{static async analyzeLink(r,i){try{const a=await b.getCachedThreat(r);if(a&&this.isCacheValid(a)){if(a.threatLevel!==s&&a.threatLevel!==t)return a;if(!(Date.now()-a.timestamp>(a.threatLevel===s?36e5:216e5)))return a;console.log("[APG] Re-analyzing cached threat due to age:",r)}const o=new URL(r).hostname;if(await b.isWhitelisted(o)){if(await this.verifyWhitelistedDomain(o)){const t={url:r,domain:o,threatLevel:e,issues:[],isWhitelisted:!0,timestamp:Date.now(),verified:!0};return await b.cacheThreat(r,t),t}console.warn("[APG] Whitelisted domain failed verification:",o),await b.removeFromWhitelist(o)}if(await b.isBlacklisted(o)){const e={url:r,domain:o,threatLevel:s,issues:[{type:"blacklisted",severity:"high",message:"Domain is in your blacklist"}],isBlacklisted:!0,timestamp:Date.now()};return await b.cacheThreat(r,e),await b.incrementBlocked(),e}const n=await D.checkPhishTank(r);if(n.found){const e={url:r,domain:o,threatLevel:s,issues:[{type:"phishtank_match",severity:"high",message:`Known phishing site (verified by ${n.source}${n.verified?" - VERIFIED":""})`}],isPhishTankMatch:!0,phishTankVerified:n.verified,timestamp:Date.now()};return await b.cacheThreat(r,e),await b.incrementBlocked(),await v.showThreatBlocked(r,e.threatLevel,1),e}const c=k(r),l=P.analyze(r);l.score>0&&(c.mlScore=l.score,c.mlConfidence=l.confidence,c.mlClassification=l.classification,l.patterns&&l.patterns.length>0&&l.patterns.forEach(e=>{c.issues.push({type:"ml_pattern",severity:e.score>10?"high":"medium",message:`ML detected: ${e.description}`,mlScore:e.score})}),l.score>=15&&c.issues.push({type:"ml_high_risk",severity:"high",message:`ML detected high-risk patterns (confidence: ${(100*l.confidence).toFixed(0)}%)`,mlScore:l.score}));const h=U.validateURL(r);h.issues.length>0&&h.issues.forEach(e=>{c.issues.push(e)});const u=this.analyzeContext(i||r);if(u>0){let e="low",t="Link appears in suspicious context";u>=9?(e="high",t="SPAM: Multiple spam indicators detected in email"):u>=5?(e="high",t="Link appears in highly suspicious context with spam indicators"):u>=3&&(e="medium",t="Link appears in suspicious phishing context"),c.issues.push({type:"suspicious_context",severity:e,message:t})}c.contextScore=u,c.threatLevel=this.calculateFinalThreatLevel(c),await b.cacheThreat(r,c),await b.incrementScanned(),c.threatLevel===s?(await b.incrementBlocked(),await v.showThreatBlocked(r,c.threatLevel,c.issues.length)):c.threatLevel===t&&u>=5&&await v.showThreatBlocked(r,c.threatLevel,c.issues.length);const d=c.issues.map(e=>e.type);return await S.recordThreat(c.threatLevel,d),c}catch(e){return console.error("Error analyzing link:",e),{url:r,threatLevel:a,issues:[{type:"error",severity:"low",message:"Analysis failed"}],error:e.message}}}static isCacheValid(e){if(!e||!e.timestamp)return!1;const t=Date.now()-e.timestamp;return e.threatLevel===s?t<36e5:t<864e5}static async verifyWhitelistedDomain(e){try{return 0===k(`https://${e}`).issues.filter(e=>"high"===e.severity).length}catch(e){return console.error("Error verifying whitelisted domain:",e),!1}}static analyzeContext(e){if(!e)return 0;const t=e.toLowerCase();let s=0,a=0;for(const e of h)t.includes(e)&&s++;for(const e of u)t.includes(e)&&(a+=3);const r=s+a;return a>0&&console.warn(`[APG] SPAM indicators found! Score: ${a}, Total: ${r}`),r}static calculateFinalThreatLevel(r){const{issues:i,isLegitimate:o,contextScore:n}=r;if(o)return e;const c=i.filter(e=>"high"===e.severity).length,l=i.filter(e=>"medium"===e.severity).length;let h=3*c+2*l+i.filter(e=>"low"===e.severity).length;return n&&(h+=n),n>=9?(console.warn(`[APG] DANGEROUS: High spam context score: ${n}`),s):n>=5?(console.warn(`[APG] SUSPICIOUS: Elevated spam context score: ${n}`),t):h>=5||c>=2?s:h>=2||c>=1||l>=2||i.length>0?t:a}static async analyzeLinks(e){const t=[];for(const s of e){const e=await this.analyzeLink(s);t.push(e)}return t}static getThreatColor(a){switch(a){case e:return"#28a745";case t:return"#ffc107";case s:return"#dc3545";default:return"#6c757d"}}static getThreatIcon(a){switch(a){case e:return"âœ“";case t:return"âš ";case s:return"âœ•";default:return"?"}}static getThreatDescription(a){switch(a){case e:return"This link appears to be safe";case t:return"This link has suspicious characteristics";case s:return"This link is likely a phishing attempt";default:return"This link could not be fully analyzed"}}static formatAnalysis(e){return{...e,color:this.getThreatColor(e.threatLevel),icon:this.getThreatIcon(e.threatLevel),description:this.getThreatDescription(e.threatLevel),issueCount:e.issues.length,highSeverityCount:e.issues.filter(e=>"high"===e.severity).length,mediumSeverityCount:e.issues.filter(e=>"medium"===e.severity).length}}}console.log("Anti-Phishing Guardian: Background service worker loaded"),chrome.runtime.onInstalled.addListener(async e=>{console.log("Extension installed/updated:",e.reason),"install"===e.reason&&(await b.saveSettings({}),console.log("Default settings initialized"),console.log("Initializing PhishTank threat intelligence..."),await D.updatePhishTankDatabase()),D.scheduleAutomaticUpdates()});const C={requests:new Map,limit:100,window:6e4,checkLimit(e){const t=Date.now(),s=this.requests.get(e)||{count:0,resetTime:t+this.window};return t>s.resetTime&&(s.count=0,s.resetTime=t+this.window),s.count>=this.limit?(console.warn(`[Security] Rate limit exceeded for sender: ${e}`),!1):(s.count++,this.requests.set(e,s),!0)}};function R(e){if(!e||"string"!=typeof e)return"";const t=e.substring(0,2048);try{return new URL(t),t}catch{return console.warn("[Security] Invalid URL provided:",t.substring(0,100)),""}}async function x(e,t,s){try{if(!e)return void s({success:!1,error:"URL required"});const a=await E.analyzeLink(e,t);s({success:!0,data:E.formatAnalysis(a)})}catch(e){console.error("Error analyzing link:",e),s({success:!1,error:"Analysis failed"})}}function I(){chrome.alarms.create("keepAlive",{periodInMinutes:1}),console.log("[Service Worker] Keep-alive alarm created")}chrome.runtime.onMessage.addListener((e,t,s)=>{if(!t||!t.id)return console.error("[Security] Message from unknown sender, rejecting"),s({success:!1,error:"Unauthorized"}),!1;if(t.id!==chrome.runtime.id)return console.error("[Security] Message from different extension, rejecting:",t.id),s({success:!1,error:"Unauthorized"}),!1;if(!e||"object"!=typeof e)return console.error("[Security] Invalid message format"),s({success:!1,error:"Invalid message format"}),!1;if(!e.action||"string"!=typeof e.action)return console.error("[Security] Missing or invalid action"),s({success:!1,error:"Invalid action"}),!1;if(!["analyzeLink","analyzeLinks","addToWhitelist","addToBlacklist","getSettings","updateSettings","getStats","clearCache"].includes(e.action))return console.error("[Security] Unknown or disallowed action:",e.action),s({success:!1,error:"Unknown action"}),!1;const a=`${t.id}-${t.tab?.id||"popup"}`;if(!C.checkLimit(a))return s({success:!1,error:"Rate limit exceeded"}),!1;const r=function(e){const t={action:String(e.action).substring(0,50)};return e.url&&(t.url=R(e.url)),e.urls&&Array.isArray(e.urls)&&(t.urls=e.urls.slice(0,100).map(e=>R(e))),e.domain&&(t.domain=function(e){if(!e||"string"!=typeof e)return"";let t=e.toLowerCase().replace(/^https?:\/\//,"").replace(/^www\./,"");return t=t.split("/")[0].split("?")[0].split("#")[0],/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?(\.[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?)*$/i.test(t)?t.substring(0,255):(console.warn("[Security] Invalid domain format:",t),"")}(e.domain)),e.context&&"string"==typeof e.context&&(t.context=e.context.substring(0,1e4)),e.settings&&"object"==typeof e.settings&&(t.settings=function(e){const t=["enabled","blockDangerous","showWarnings","notifyDangerous","notifySuspicious","notifyUpdates","protectionLevel"],s={};for(const a of t)a in e&&("boolean"==typeof e[a]?s[a]=e[a]:"string"==typeof e[a]&&(s[a]=String(e[a]).substring(0,50)));return s}(e.settings)),t}(e);switch(console.log("[Security] Validated message:",r.action),r.action){case"analyzeLink":return x(r.url,r.context,s),!0;case"analyzeLinks":return async function(e,t){try{if(!e||!Array.isArray(e)||0===e.length)return void t({success:!1,error:"Invalid URLs array"});t({success:!0,data:(await E.analyzeLinks(e)).map(e=>E.formatAnalysis(e))})}catch(e){console.error("Error analyzing links:",e),t({success:!1,error:"Analysis failed"})}}(r.urls,s),!0;case"addToWhitelist":return async function(e,t){try{if(!e)return void t({success:!1,error:"Domain required"});await b.addToWhitelist(e),await b.clearCache(),t({success:!0})}catch(e){console.error("Error adding to whitelist:",e),t({success:!1,error:"Operation failed"})}}(r.domain,s),!0;case"addToBlacklist":return async function(e,t){try{if(!e)return void t({success:!1,error:"Domain required"});await b.addToBlacklist(e),await b.clearCache(),t({success:!0})}catch(e){console.error("Error adding to blacklist:",e),t({success:!1,error:"Operation failed"})}}(r.domain,s),!0;case"getSettings":return async function(e){try{e({success:!0,data:await b.getSettings()})}catch(t){console.error("Error getting settings:",t),e({success:!1,error:t.message})}}(s),!0;case"updateSettings":return async function(e,t){try{if(!e||"object"!=typeof e)return void t({success:!1,error:"Invalid settings"});await b.saveSettings(e),t({success:!0})}catch(e){console.error("Error updating settings:",e),t({success:!1,error:"Operation failed"})}}(r.settings,s),!0;case"getStats":return async function(e){try{e({success:!0,data:await b.getStats()})}catch(t){console.error("Error getting stats:",t),e({success:!1,error:t.message})}}(s),!0;case"clearCache":return async function(e){try{await b.clearCache(),e({success:!0})}catch(t){console.error("Error clearing cache:",t),e({success:!1,error:t.message})}}(s),!0;default:return console.error("[Security] Unexpected action bypass:",r.action),s({success:!1,error:"Invalid action"}),!1}}),chrome.runtime.onStartup.addListener(()=>{console.log("Extension started"),D.scheduleAutomaticUpdates()}),chrome.alarms.onAlarm.addListener(e=>{"keepAlive"===e.name&&(console.log("[Service Worker] Keep-alive ping"),D.getDatabaseStats().then(e=>{e.exists&&e.needsUpdate&&(console.log("[Service Worker] Database needs update, triggering refresh"),D.updatePhishTankDatabase())}).catch(e=>{console.error("[Service Worker] Health check failed:",e)}))}),I(),chrome.runtime.onInstalled.addListener(e=>{"update"===e.reason&&(console.log("[Service Worker] Extension updated, re-establishing keep-alive"),I())});const A=new Map;chrome.runtime.onConnect.addListener(e=>{console.log("[Service Worker] New connection established:",e.name);const t=e.sender?.tab?.id;if(t){A.set(t,e),e.onDisconnect.addListener(()=>{console.log("[Service Worker] Connection closed:",e.name),A.delete(t)});const s=setInterval(()=>{try{e.postMessage({type:"ping"})}catch(e){clearInterval(s),A.delete(t)}},2e4);e.onMessage.addListener(e=>{"pong"===e.type&&console.log("[Service Worker] Received pong from tab:",t)})}});let z=0;const B=x;x=async function(e,t,s){z++,console.log("[Service Worker] Active operations:",z);try{await B(e,t,s)}finally{z=Math.max(0,z-1),console.log("[Service Worker] Active operations:",z)}},console.log("[Service Worker] Keep-alive mechanisms initialized")})();