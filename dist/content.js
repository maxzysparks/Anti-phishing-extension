(()=>{console.log("Anti-Phishing Guardian: Content script loaded"),console.log("[APG] Current URL:",window.location.href);let e={},t=new Set;function n(){const r=document.querySelectorAll("a[href]");console.log(`[APG] Scanning ${r.length} links on page`);let c=0;r.forEach(r=>{const d=r.href;t.has(d)||(d.startsWith("mailto:")||d.startsWith("tel:")||d.startsWith("#")?console.log("[APG] Skipping non-http link:",d.substring(0,50)):!d.includes("mail.google.com")||d.includes("http")?(t.add(d),c++,console.log(`[APG] Processing link ${c}:`,d.substring(0,100)),function(e){const t=t=>{t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),function(e){const t=document.createElement("span");t.className="apg-analyzing",t.textContent="‚è≥",t.style.marginLeft="4px",t.style.fontSize="14px",t.title="Analyzing link safety...",e.appendChild(t)}(e)};e.addEventListener("click",t,{capture:!0,once:!1}),e._analysisHandler=t}(r),async function(r,c){try{const d=function(e){let t="";const n=e.closest('[role="article"]')||e.closest(".email-body")||e.closest("[data-message-id]")||e.closest(".message-content");if(n)t=n.textContent||"";else{const n=e.closest("p")||e.closest("div");n&&(t=n.textContent||"")}const o=e.textContent||"";let a="";const s=document.querySelector("[data-legacy-thread-id] h2")||document.querySelector(".subject")||document.querySelector('[role="heading"]');return s&&(a=s.textContent||""),{surrounding:t.toLowerCase(),linkText:o.toLowerCase(),subject:a.toLowerCase(),fullContext:(a+" "+o+" "+t).toLowerCase()}}(r);console.log("[APG] Analyzing link:",c.substring(0,100)),console.log("[APG] Context length:",d.fullContext.length,"chars");const p=await chrome.runtime.sendMessage({action:"analyzeLink",url:c,context:d.fullContext});if(p&&p.success){const c=p.data;console.log("[APG] Analysis result:",c.threatLevel,"- Issues:",c.issues.length),o(r),r._analysisHandler&&(r.removeEventListener("click",r._analysisHandler,{capture:!0}),delete r._analysisHandler),a(r,c),e.showWarnings&&function(e,o){e.addEventListener("mouseenter",e=>{!function(e,o){l();const a=document.createElement("div");a.id="apg-tooltip",a.className="apg-tooltip";const r=document.createElement("div");r.className="apg-tooltip-header",r.style.backgroundColor=i(o.color);const c=document.createElement("span");c.className="apg-tooltip-icon",c.textContent=s(o.icon);const d=document.createElement("span");d.className="apg-tooltip-title",d.textContent=s(o.description),r.appendChild(c),r.appendChild(d);const p=document.createElement("div");p.className="apg-tooltip-body";const g=document.createElement("div");g.className="apg-tooltip-url",g.textContent=s(o.url);const u=document.createElement("div");if(u.className="apg-tooltip-domain",u.textContent=`Domain: ${s(o.domain)||"N/A"}`,p.appendChild(g),p.appendChild(u),o.issues&&o.issues.length>0){const e=document.createElement("div");e.className="apg-tooltip-issues";const t=document.createElement("strong");t.textContent="Issues Found:",e.appendChild(t);const n=document.createElement("ul");o.issues.forEach(e=>{const t=document.createElement("li"),o=document.createElement("span");o.style.color=i("high"===e.severity?"#dc3545":"medium"===e.severity?"#ffc107":"#6c757d"),o.textContent=`[${s(e.severity)}] `;const a=document.createTextNode(s(e.message));t.appendChild(o),t.appendChild(a),n.appendChild(t)}),e.appendChild(n),p.appendChild(e)}const m=document.createElement("div");m.className="apg-tooltip-actions";const h=document.createElement("button");h.className="apg-btn apg-btn-whitelist",h.setAttribute("data-domain",s(o.domain)),h.textContent="Trust Domain";const y=document.createElement("button");y.className="apg-btn apg-btn-blacklist",y.setAttribute("data-domain",s(o.domain)),y.textContent="Block Domain",m.appendChild(h),m.appendChild(y),p.appendChild(m),a.appendChild(r),a.appendChild(p),document.body.appendChild(a);const f=e.target.getBoundingClientRect();a.style.position="fixed",a.style.top=f.bottom+10+"px",a.style.left=f.left+"px",a.style.zIndex="10000",h.addEventListener("click",e=>{e.stopPropagation(),async function(e){try{await chrome.runtime.sendMessage({action:"addToWhitelist",domain:e}),l(),t.clear(),n(),alert(`Domain "${e}" has been added to your whitelist.`)}catch(e){console.error("Error adding to whitelist:",e)}}(e.target.dataset.domain)}),y.addEventListener("click",e=>{e.stopPropagation(),async function(e){try{await chrome.runtime.sendMessage({action:"addToBlacklist",domain:e}),l(),t.clear(),n(),alert(`Domain "${e}" has been added to your blacklist.`)}catch(e){console.error("Error adding to blacklist:",e)}}(e.target.dataset.domain)})}(e,o)}),e.addEventListener("mouseleave",()=>{l()})}(r,c),e.blockDangerous&&"dangerous"===c.threatLevel&&function(e,t){e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),confirm(`‚ö†Ô∏è PHISHING WARNING ‚ö†Ô∏è\n\nThis link has been identified as potentially dangerous:\n\n${t.description}\n\nURL: ${t.url}\n\nIssues found: ${t.issueCount}\n\nDo you really want to proceed? (NOT RECOMMENDED)`)&&window.open(t.url,"_blank")},!0)}(r,c)}else console.warn("[APG] No valid response from background script")}catch(e){if(e.message&&e.message.includes("Extension context invalidated")){if(console.error("[APG] Extension was reloaded. Please REFRESH this page (F5) to reconnect."),!document.getElementById("apg-reload-notice")){const e=document.createElement("div");e.id="apg-reload-notice",e.style.cssText="\n          position: fixed;\n          top: 20px;\n          right: 20px;\n          background: #ff9800;\n          color: white;\n          padding: 15px 20px;\n          border-radius: 8px;\n          box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n          z-index: 999999;\n          font-family: Arial, sans-serif;\n          font-size: 14px;\n          max-width: 350px;\n        ",e.innerHTML='\n          <strong>üõ°Ô∏è Anti-Phishing Guardian</strong><br>\n          Extension was updated. Please refresh this page (F5) to activate protection.\n          <button style="margin-top:10px;padding:5px 10px;background:white;color:#ff9800;border:none;border-radius:4px;cursor:pointer;font-weight:bold;" onclick="location.reload()">Refresh Now</button>\n        ',document.body.appendChild(e)}return}console.error("[APG] Error analyzing link:",e),o(r),r._analysisHandler&&(r.removeEventListener("click",r._analysisHandler,{capture:!0}),delete r._analysisHandler)}}(r,d)):console.log("[APG] Skipping Gmail internal link"))}),c>0?console.log(`[APG] Found ${c} new links to analyze`):console.log("[APG] No new links found in this scan")}function o(e){const t=e.querySelector(".apg-analyzing");t&&t.remove()}function a(e,t){const n=e.querySelector(".apg-indicator");n&&n.remove();const o=document.createElement("span");o.className="apg-indicator",o.textContent=t.icon,o.style.cssText=`\n    margin-left: 4px !important;\n    color: ${t.color} !important;\n    font-weight: bold !important;\n    font-size: 14px !important;\n    display: inline !important;\n    visibility: visible !important;\n    opacity: 1 !important;\n  `,o.title=t.description,e.style.cssText+=`\n    border-bottom: 2px solid ${t.color} !important;\n    padding-bottom: 2px !important;\n  `;const s=o.attachShadow?o.attachShadow({mode:"closed"}):null;if(s){const e=document.createElement("style");e.textContent=`\n      :host {\n        margin-left: 4px !important;\n        color: ${t.color} !important;\n        font-weight: bold !important;\n        font-size: 14px !important;\n      }\n    `,s.appendChild(e);const n=document.createElement("span");n.textContent=t.icon,s.appendChild(n)}e.appendChild(o);const i=btoa(`${t.threatLevel}-${Date.now()}`);e.setAttribute("data-apg-threat",t.threatLevel),e.setAttribute("data-apg-integrity",i),e._apgAnalysis=Object.freeze(t),function(e,t){const n=new MutationObserver(n=>{n.forEach(n=>{"childList"===n.type&&n.removedNodes.length>0&&Array.from(n.removedNodes).some(e=>"apg-indicator"===e.className)&&(console.warn("[APG] Tampering detected: Indicator removed. Restoring..."),e._apgAnalysis&&a(e,e._apgAnalysis)),"attributes"===n.type&&e.getAttribute("data-apg-integrity")!==t&&(console.warn("[APG] Tampering detected: Attributes modified. Restoring..."),e.setAttribute("data-apg-integrity",t))})});n.observe(e,{childList:!0,attributes:!0,attributeFilter:["data-apg-threat","data-apg-integrity","style","class"]}),e._apgObserver=n}(e,i)}function s(e){return e?String(e).substring(0,1e3).replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;"):""}function i(e){return e?/^#[0-9A-Fa-f]{6}$/.test(e)?e:{green:"#28a745",yellow:"#ffc107",red:"#dc3545",gray:"#6c757d"}[e]||"#000000":"#000000"}function l(){const e=document.getElementById("apg-tooltip");e&&e.remove()}!async function(){console.log("[APG] Initializing content script...");try{const t=await chrome.runtime.sendMessage({action:"getSettings"});t&&t.success?(e=t.data,console.log("[APG] Settings loaded:",e)):(console.warn("[APG] Failed to load settings, using defaults"),e={enabled:!0})}catch(t){console.error("[APG] Error loading settings:",t),e={enabled:!0}}console.log("[APG] Starting link monitoring..."),function(){console.log("[APG] startMonitoring called");const e=setInterval(()=>{const t=document.querySelector('[role="main"]')||document.querySelector(".nH")||document.body;t&&(console.log("[APG] Gmail interface detected, starting scan"),clearInterval(e),n(),new MutationObserver(e=>{console.log("[APG] DOM mutation detected, rescanning..."),n()}).observe(t,{childList:!0,subtree:!0}),console.log("[APG] Link monitoring started successfully"))},500);setTimeout(()=>{clearInterval(e),console.log("[APG] Gmail load timeout, starting anyway"),n()},1e4)}()}(),chrome.runtime.onMessage.addListener((o,a,s)=>{"settingsUpdated"===o.action&&(e=o.settings,t.clear(),n())}),window.addEventListener("beforeunload",()=>{l()})})();