(()=>{console.log("Anti-Phishing Guardian: Content script loaded");let t={},e=new Set;function n(){document.querySelectorAll("a[href]").forEach(c=>{const l=c.href;e.has(l)||l.startsWith("mailto:")||l.startsWith("tel:")||l.startsWith("#")||(e.add(l),function(t){const e=e=>{e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),function(t){const e=document.createElement("span");e.className="apg-analyzing",e.textContent="⏳",e.style.marginLeft="4px",e.style.fontSize="14px",e.title="Analyzing link safety...",t.appendChild(e)}(t)};t.addEventListener("click",e,{capture:!0,once:!1}),t._analysisHandler=e}(c),async function(c,l){try{const d=function(t){let e="";const n=t.closest('[role="article"]')||t.closest(".email-body")||t.closest("[data-message-id]")||t.closest(".message-content");if(n)e=n.textContent||"";else{const n=t.closest("p")||t.closest("div");n&&(e=n.textContent||"")}const a=t.textContent||"";let o="";const i=document.querySelector("[data-legacy-thread-id] h2")||document.querySelector(".subject")||document.querySelector('[role="heading"]');return i&&(o=i.textContent||""),{surrounding:e.toLowerCase(),linkText:a.toLowerCase(),subject:o.toLowerCase(),fullContext:(o+" "+a+" "+e).toLowerCase()}}(c),p=await chrome.runtime.sendMessage({action:"analyzeLink",url:l,context:d.fullContext});if(p.success){const l=p.data;a(c),c._analysisHandler&&(c.removeEventListener("click",c._analysisHandler,{capture:!0}),delete c._analysisHandler),o(c,l),t.showWarnings&&function(t,a){t.addEventListener("mouseenter",t=>{!function(t,a){r();const o=document.createElement("div");o.id="apg-tooltip",o.className="apg-tooltip";const c=document.createElement("div");c.className="apg-tooltip-header",c.style.backgroundColor=s(a.color);const l=document.createElement("span");l.className="apg-tooltip-icon",l.textContent=i(a.icon);const d=document.createElement("span");d.className="apg-tooltip-title",d.textContent=i(a.description),c.appendChild(l),c.appendChild(d);const p=document.createElement("div");p.className="apg-tooltip-body";const m=document.createElement("div");m.className="apg-tooltip-url",m.textContent=i(a.url);const u=document.createElement("div");if(u.className="apg-tooltip-domain",u.textContent=`Domain: ${i(a.domain)||"N/A"}`,p.appendChild(m),p.appendChild(u),a.issues&&a.issues.length>0){const t=document.createElement("div");t.className="apg-tooltip-issues";const e=document.createElement("strong");e.textContent="Issues Found:",t.appendChild(e);const n=document.createElement("ul");a.issues.forEach(t=>{const e=document.createElement("li"),a=document.createElement("span");a.style.color=s("high"===t.severity?"#dc3545":"medium"===t.severity?"#ffc107":"#6c757d"),a.textContent=`[${i(t.severity)}] `;const o=document.createTextNode(i(t.message));e.appendChild(a),e.appendChild(o),n.appendChild(e)}),t.appendChild(n),p.appendChild(t)}const g=document.createElement("div");g.className="apg-tooltip-actions";const h=document.createElement("button");h.className="apg-btn apg-btn-whitelist",h.setAttribute("data-domain",i(a.domain)),h.textContent="Trust Domain";const y=document.createElement("button");y.className="apg-btn apg-btn-blacklist",y.setAttribute("data-domain",i(a.domain)),y.textContent="Block Domain",g.appendChild(h),g.appendChild(y),p.appendChild(g),o.appendChild(c),o.appendChild(p),document.body.appendChild(o);const f=t.target.getBoundingClientRect();o.style.position="fixed",o.style.top=f.bottom+10+"px",o.style.left=f.left+"px",o.style.zIndex="10000",h.addEventListener("click",t=>{t.stopPropagation(),async function(t){try{await chrome.runtime.sendMessage({action:"addToWhitelist",domain:t}),r(),e.clear(),n(),alert(`Domain "${t}" has been added to your whitelist.`)}catch(t){console.error("Error adding to whitelist:",t)}}(t.target.dataset.domain)}),y.addEventListener("click",t=>{t.stopPropagation(),async function(t){try{await chrome.runtime.sendMessage({action:"addToBlacklist",domain:t}),r(),e.clear(),n(),alert(`Domain "${t}" has been added to your blacklist.`)}catch(t){console.error("Error adding to blacklist:",t)}}(t.target.dataset.domain)})}(t,a)}),t.addEventListener("mouseleave",()=>{r()})}(c,l),t.blockDangerous&&"dangerous"===l.threatLevel&&function(t,e){t.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),confirm(`⚠️ PHISHING WARNING ⚠️\n\nThis link has been identified as potentially dangerous:\n\n${e.description}\n\nURL: ${e.url}\n\nIssues found: ${e.issueCount}\n\nDo you really want to proceed? (NOT RECOMMENDED)`)&&window.open(e.url,"_blank")},!0)}(c,l)}}catch(t){console.error("Error analyzing link:",t),a(c),c._analysisHandler&&(c.removeEventListener("click",c._analysisHandler,{capture:!0}),delete c._analysisHandler)}}(c,l))})}function a(t){const e=t.querySelector(".apg-analyzing");e&&e.remove()}function o(t,e){const n=t.querySelector(".apg-indicator");n&&n.remove();const a=document.createElement("span");a.className="apg-indicator",a.textContent=e.icon,a.style.cssText=`\n    margin-left: 4px !important;\n    color: ${e.color} !important;\n    font-weight: bold !important;\n    font-size: 14px !important;\n    display: inline !important;\n    visibility: visible !important;\n    opacity: 1 !important;\n  `,a.title=e.description,t.style.cssText+=`\n    border-bottom: 2px solid ${e.color} !important;\n    padding-bottom: 2px !important;\n  `;const i=a.attachShadow?a.attachShadow({mode:"closed"}):null;if(i){const t=document.createElement("style");t.textContent=`\n      :host {\n        margin-left: 4px !important;\n        color: ${e.color} !important;\n        font-weight: bold !important;\n        font-size: 14px !important;\n      }\n    `,i.appendChild(t);const n=document.createElement("span");n.textContent=e.icon,i.appendChild(n)}t.appendChild(a);const s=btoa(`${e.threatLevel}-${Date.now()}`);t.setAttribute("data-apg-threat",e.threatLevel),t.setAttribute("data-apg-integrity",s),t._apgAnalysis=Object.freeze(e),function(t,e){const n=new MutationObserver(n=>{n.forEach(n=>{"childList"===n.type&&n.removedNodes.length>0&&Array.from(n.removedNodes).some(t=>"apg-indicator"===t.className)&&(console.warn("[APG] Tampering detected: Indicator removed. Restoring..."),t._apgAnalysis&&o(t,t._apgAnalysis)),"attributes"===n.type&&t.getAttribute("data-apg-integrity")!==e&&(console.warn("[APG] Tampering detected: Attributes modified. Restoring..."),t.setAttribute("data-apg-integrity",e))})});n.observe(t,{childList:!0,attributes:!0,attributeFilter:["data-apg-threat","data-apg-integrity","style","class"]}),t._apgObserver=n}(t,s)}function i(t){return t?String(t).substring(0,1e3).replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;"):""}function s(t){return t?/^#[0-9A-Fa-f]{6}$/.test(t)?t:{green:"#28a745",yellow:"#ffc107",red:"#dc3545",gray:"#6c757d"}[t]||"#000000":"#000000"}function r(){const t=document.getElementById("apg-tooltip");t&&t.remove()}!async function(){const e=await chrome.runtime.sendMessage({action:"getSettings"});e.success&&(t=e.data),t.enabled&&(n(),new MutationObserver(t=>{n()}).observe(document.body,{childList:!0,subtree:!0}),console.log("Link monitoring started"))}(),chrome.runtime.onMessage.addListener((a,o,i)=>{"settingsUpdated"===a.action&&(t=a.settings,e.clear(),n())}),window.addEventListener("beforeunload",()=>{r()})})();